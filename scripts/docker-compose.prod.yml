version: '3.8'

services:
  # NGINX Load Balancer
  nginx:
    image: nginx:alpine
    container_name: atlas-nginx-lb
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - python-api-gateway
    networks:
      - atlas-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 3s
      retries: 3

  # PostgreSQL Backup Service
  postgres-backup:
    image: prodrigestivill/postgres-backup-local:15-alpine
    container_name: atlas-postgres-backup
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: atlas
      POSTGRES_USER: atlas
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-atlas_dev}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      BACKUP_KEEP_WEEKS: 4
      BACKUP_KEEP_MONTHS: 6
      HEALTHCHECK_PORT: 8080
    volumes:
      - ./backups/postgres:/backups
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - atlas-network
    restart: unless-stopped

  # PostGIS Backup Service
  postgis-backup:
    image: prodrigestivill/postgres-backup-local:15-alpine
    container_name: atlas-postgis-backup
    environment:
      POSTGRES_HOST: postgis
      POSTGRES_DB: atlas_geo
      POSTGRES_USER: atlas
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-atlas_dev}
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 7
      BACKUP_KEEP_WEEKS: 4
      BACKUP_KEEP_MONTHS: 6
      HEALTHCHECK_PORT: 8081
    volumes:
      - ./backups/postgis:/backups
    depends_on:
      postgis:
        condition: service_healthy
    networks:
      - atlas-network
    restart: unless-stopped

volumes:
  nginx_logs:

networks:
  atlas-network:
    external: true
